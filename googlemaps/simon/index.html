<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Maps Project</title>
</head>

<body>

    <div style="width: 100%; height:90vh;" id="map"></div>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAELHB8xMh6IKT7vmFbneLdCjqkdK88L4o&callback=initMap&libraries=drawing,geometry&v=weekly"
        async></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var apiKey = 'AIzaSyAELHB8xMh6IKT7vmFbneLdCjqkdK88L4o';
        var routeMarkers = [], routePath;
        var map, infoWindowStartPoint, infoWindowLastPoint, snappedPolyline, snappedPolylineGmaps;
        var polygonFeatures = [];
        var isfirstLoad = true;


        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: {
                    lat: 38.88999939,
                    lng: -104.83200073
                },
                zoom: 4,
            });
            infoWindowLastPoint = new google.maps.InfoWindow();
            infoWindowOtherPoints = new google.maps.InfoWindow();

            snappedPolyline = new google.maps.Polyline({
                strokeColor: '#3b8ced',
                strokeWeight: 5,
                strokeOpacity: 0.9,
                map: map,
            });

            snappedPolylineGmaps = new google.maps.Polyline({
                strokeColor: '#fcba03',
                strokeWeight: 5,
                strokeOpacity: 0.9,
                map: map,
            });

            loadRoute();

            const centerControlDiv = document.createElement("div");
            CenterControl(centerControlDiv, map);
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
        }

        function loadRoute() {
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: 'https://www.followmee.com/api/tracks.aspx',
                dataType: "jsonp",
                data: {
                    key: '6a4b18edbcfb18d91a4d8abc7fc18496',
                    username: 'simonpflwmeH57cA',
                    output: 'json',
                    deviceid: 12494168,
                    //function: 'historyfordevice',
                    //history: 168
                    function: 'daterangefordevice',
                    from: '2021-05-30',
                    to: '2021-06-3'
                },
                success: function (data) {
                    var cont = true;
                    if (data.Error != null) {
                        console.error(data.Error);
                        cont = false;
                    } else {
                        addRouteToMap(data.Data);
                    }
                }
            });

        }

        function addRouteToMap(routePoints) {
            routeMarkers.forEach(rm => {
                rm.marker.setMap(null);
            });
            routeMarkers = [];
            routePoints = routePoints.sort((a, b) => moment(a.Date).format('YYYYMMDDHHmmss') - moment(b.Date).format('YYYYMMDDHHmmss'));
            routePoints.forEach(rp => {
                //find last route
                if (routeMarkers.length > 0) {
                    let a = moment(routeMarkers[routeMarkers.length - 1].routePointProperties.Date);
                    let b = moment(rp.Date);
                    if (b.diff(a, 'minutes') > 60) {
                        routeMarkers = [];
                    }
                }

                routeMarkers.push({
                    routePointProperties: rp,
                    marker: new google.maps.Marker({
                        position: {
                            lat: rp.Latitude,
                            lng: rp.Longitude
                        },
                    }),
                    popupContent: `
                        Time:<b> ${moment(rp.Date).format('h:mm:ss a')}</b> <br>
                        Speed:<b> ${rp['Speed(mph)']}mph(${rp['Speed(km/h)']}km/h)</b> <br>
                        Altitude:<b> ${rp['Altitude(ft)']}ft(${rp['Altitude(m)']}m)</b>
                        `
                });
            });

            if (isfirstLoad) {
                //  Create a new viewpoint bound
                var bounds = new google.maps.LatLngBounds();
                routeMarkers.forEach(rm => {
                    bounds.extend(rm.marker.getPosition());
                });

                //  Fit these bounds to the map
                map.fitBounds(bounds);
                isfirstLoad = false;
            }

            //show markers
            if (routeMarkers.length > 1) {
                routeMarkers[routeMarkers.length - 1].marker.setIcon("bigM.png?v2");
                routeMarkers[routeMarkers.length - 1].marker.setMap(map);
                routeMarkers[routeMarkers.length - 1].marker.addListener("click", () => {
                    infoWindowLastPoint.close();
                    infoWindowLastPoint.setContent(routeMarkers[routeMarkers.length - 1].popupContent);
                    infoWindowLastPoint.open(routeMarkers[routeMarkers.length - 1].marker.getMap(), routeMarkers[routeMarkers.length - 1].marker);
                });
            }
            if (routeMarkers.length > 1) {
                for (i = 0; i < routeMarkers.length - 1; i++) {
                    routeMarkers[i].marker.setIcon({
                        url: "8px-gray-dot.svg.png",
                        anchor: new google.maps.Point(4, 4)
                    });
                    routeMarkers[i].marker.setMap(map);
                    let rm = routeMarkers[i];
                    rm.marker.addListener("click", () => {
                        console.log("clicked");
                        infoWindowOtherPoints.close();
                        infoWindowOtherPoints.setContent(rm.popupContent);
                        infoWindowOtherPoints.open(rm.marker.getMap(), rm.marker);
                    });
                }
            }

            if (routePath) {
                routePath.setMap(null);
                routePath = null;
            }

            routePath = new google.maps.Polyline({
                path: routeMarkers.map(rm => rm.marker.getPosition()),
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 3,
            });
            routePath.setMap(map);

            runSnapToRoadMapbox(routePath.getPath());
            runSnapToRoadGmaps(routePath.getPath());

            setTimeout(() => {
                loadRoute();
            }, 1000 * 60);


        }

        // Snap a user-created polyline to roads and draw the snapped path
        function runSnapToRoadMapbox(path) {
            snappedPolyline.getPath().clear();
            var pathValuesContainer = [];
            for (var i = 0; i < path.getLength(); i++) {
                let mod = Math.floor(i / 100);
                if (pathValuesContainer[mod]) {
                    pathValuesContainer[mod].push(path.getAt(i).toUrlValue().split(',').reverse().join());
                }
                else {
                    pathValuesContainer[mod] = [];
                    pathValuesContainer[mod].push(path.getAt(i).toUrlValue().split(',').reverse().join());
                }
            }

            console.log(pathValuesContainer);
            pathValuesContainer.forEach((pathValues, pathValuesContainerIndex) => {
                $.get('https://api.mapbox.com/matching/v5/mapbox/walking/' + pathValues.join(';'), {
                    access_token: 'pk.eyJ1IjoiYWNlbWltdWhlbmRpcyIsImEiOiJjajNvZnZvd3IwMDI0MnJydHhpZjZ5bnRsIn0.mVZMKTNJSZ0rWxy1F7nXhg',
                    geometries: 'geojson'
                }, function (data) {

                    if (data.code == 'Ok') {
                        let lastAddedMatchingIndex = -1;
                        data.tracepoints.forEach((tracepoint, index) => {
                            if (tracepoint) {
                                if (lastAddedMatchingIndex != tracepoint.matchings_index) {
                                    lastAddedMatchingIndex = tracepoint.matchings_index;
                                    for (var i = 0; i < data.matchings[lastAddedMatchingIndex].geometry.coordinates.length; i++) {
                                        var latlng = new google.maps.LatLng(
                                            data.matchings[lastAddedMatchingIndex].geometry.coordinates[i][1],
                                            data.matchings[lastAddedMatchingIndex].geometry.coordinates[i][0]);
                                        snappedPolyline.getPath().push(latlng);
                                    }
                                }
                            } else {
                                //snappedPolyline.getPath().push(path.getAt(index+(pathValuesContainerIndex*100)));
                            }
                        });
                    }

                });

            });


        }

        // Snap a user-created polyline to roads and draw the snapped path
        function runSnapToRoadGmaps(path) {
            snappedPolylineGmaps.getPath().clear();
            var pathValues = [];
            for (var i = 0; i < path.getLength(); i++) {
                pathValues.push(path.getAt(i).toUrlValue());
            }

            var pathValuesContainer = [];
            for (var i = 0; i < path.getLength(); i++) {
                let mod = Math.floor(i / 100);
                if (pathValuesContainer[mod]) {
                    pathValuesContainer[mod].push(path.getAt(i).toUrlValue());
                }
                else {
                    pathValuesContainer[mod] = [];
                    pathValuesContainer[mod].push(path.getAt(i).toUrlValue());
                }
            }

            pathValuesContainer.forEach((pathValues, pathValuesContainerIndex) => {
                $.get('https://roads.googleapis.com/v1/snapToRoads', {
                    interpolate: true,
                    key: apiKey,
                    path: pathValues.join('|')
                }, function (data) {
                    for (var i = 0; i < data.snappedPoints.length; i++) {
                        var latlng = new google.maps.LatLng(
                            data.snappedPoints[i].location.latitude,
                            data.snappedPoints[i].location.longitude);
                        snappedPolylineGmaps.getPath().push(latlng);
                    }
                });
            });


        }

        const chicago = { lat: 41.85, lng: -87.65 };
        function CenterControl(controlDiv, map) {
            // Set CSS for the control border.
            const controlUI = document.createElement("div");
            controlUI.style.backgroundColor = "#fff";
            controlUI.style.border = "2px solid #fff";
            controlUI.style.borderRadius = "3px";
            controlUI.style.boxShadow = "0 2px 6px rgba(0,0,0,.3)";
            controlUI.style.marginTop = "8px";
            controlUI.style.marginBottom = "22px";
            controlUI.style.textAlign = "center";
            controlUI.title = "Click to recenter the map";
            controlDiv.appendChild(controlUI);
            // Set CSS for the control interior.
            const chkOriginal = document.createElement("INPUT");
            chkOriginal.setAttribute("type", "checkbox");
            chkOriginal.checked = true;
            chkOriginal.id = "original";
            const lblOriginal = document.createElement("Label");
            lblOriginal.setAttribute("for",  "original");
            lblOriginal.innerHTML = "Original Data";

            controlUI.appendChild(chkOriginal);
            controlUI.appendChild(lblOriginal);
            chkOriginal.addEventListener("click", () => {
                console.log(chkOriginal.checked)
                routePath.setVisible(chkOriginal.checked);
                routeMarkers.map(rm => rm.marker.setVisible(chkOriginal.checked))
            });

            //mapbox
            const chkMapbox = document.createElement("INPUT");
            chkMapbox.setAttribute("type", "checkbox");
            chkMapbox.checked = true;
            chkMapbox.id = "mapbox";
            const lblMapbox = document.createElement("Label");
            lblMapbox.setAttribute("for",  "mapbox");
            lblMapbox.innerHTML = "Mapbox Matching";

            controlUI.appendChild(chkMapbox);
            controlUI.appendChild(lblMapbox);
            chkMapbox.addEventListener("click", () => {
                console.log(chkMapbox.checked)
                snappedPolyline.setVisible(chkMapbox.checked);
            });

            //google roads
            const chkGoogleSnap = document.createElement("INPUT");
            chkGoogleSnap.setAttribute("type", "checkbox");
            chkGoogleSnap.checked = true;
            chkGoogleSnap.id = "chkGoogleSnap";
            const lblGoogleSnap = document.createElement("Label");
            lblGoogleSnap.setAttribute("for",  "chkGoogleSnap");
            lblGoogleSnap.innerHTML = "Google Snap To Road";

            controlUI.appendChild(chkGoogleSnap);
            controlUI.appendChild(lblGoogleSnap);
            chkGoogleSnap.addEventListener("click", () => {
                console.log(chkGoogleSnap.checked)
                snappedPolylineGmaps.setVisible(chkGoogleSnap.checked);
            });
        }




    </script>


</body>

</html>