<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Maps Project</title>
</head>

<body>

    <div style="width: 100%; height:90vh;" id="map"></div>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAELHB8xMh6IKT7vmFbneLdCjqkdK88L4o&callback=initMap&libraries=drawing,geometry&v=weekly"
        async></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var apiKey = 'AIzaSyAELHB8xMh6IKT7vmFbneLdCjqkdK88L4o';
        var routeMarkers = [], routePath;
        var map, infoWindowStartPoint, infoWindowLastPoint;
        var polygonFeatures = [];
        var isfirstLoad = true;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: {
                    lat: 38.88999939,
                    lng: -104.83200073
                },
                zoom: 4,
            });
            infoWindowLastPoint = new google.maps.InfoWindow();
            infoWindowOtherPoints = new google.maps.InfoWindow();

            loadRoute();
        }

        function loadRoute() {

            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: 'https://www.followmee.com/api/tracks.aspx',
                dataType: "jsonp",
                data: {
                    key: '6a4b18edbcfb18d91a4d8abc7fc18496',
                    username: 'simonpflwmeH57cA',
                    output: 'json',
                    deviceid: 12494168,
                    function: 'historyfordevice',
                    history:168
                    //function: 'daterangefordevice',
                    //from: '2021-06-01',
                    //to: '2021-06-01'
                },
                success: function (data) {
                    console.log(data);
                    var cont = true;
                    if (data.Error != null) {
                        console.error(data.Error);
                        cont = false;
                    } else {
                        addRouteToMap(data.Data);
                    }
                }
            });

        }

        function addRouteToMap(routePoints) {
            routeMarkers.forEach(rm => {
                rm.marker.setMap(null);
            });
            routeMarkers = [];
            routePoints = routePoints.sort((a, b) => moment(a.Date).format('YYYYMMDDHHmmss') - moment(b.Date).format('YYYYMMDDHHmmss'));
            routePoints.forEach(rp => {
                //find last route
                if (routeMarkers.length > 0) {
                    let a = moment(routeMarkers[routeMarkers.length - 1].routePointProperties.Date);
                    let b = moment(rp.Date);
                    if (b.diff(a, 'minutes') > 60) {
                        routeMarkers = [];
                    }
                }

                routeMarkers.push({
                    routePointProperties: rp,
                    marker: new google.maps.Marker({
                        position: {
                            lat: rp.Latitude,
                            lng: rp.Longitude
                        },
                    }),
                    popupContent: `
                        Time:<b> ${moment(rp.Date).format('h:mm:ss a')}</b> <br>
                        Speed:<b> ${rp['Speed(mph)']}mph(${rp['Speed(km/h)']}km/h)</b> <br>
                        Altitude:<b> ${rp['Altitude(ft)']}ft(${rp['Altitude(m)']}m)</b>
                        `
                });
            });

            if (isfirstLoad) {
                //  Create a new viewpoint bound
                var bounds = new google.maps.LatLngBounds();
                routeMarkers.forEach(rm => {
                    bounds.extend(rm.marker.getPosition());
                });

                //  Fit these bounds to the map
                map.fitBounds(bounds);
                isfirstLoad = false;
            }

            //show markers
            if (routeMarkers.length > 1) {
                routeMarkers[routeMarkers.length - 1].marker.setIcon("bigM.png?v2");
                routeMarkers[routeMarkers.length - 1].marker.setMap(map);
                routeMarkers[routeMarkers.length - 1].marker.addListener("click", () => {
                    infoWindowLastPoint.close();
                    infoWindowLastPoint.setContent(routeMarkers[routeMarkers.length - 1].popupContent);
                    infoWindowLastPoint.open(routeMarkers[routeMarkers.length - 1].marker.getMap(), routeMarkers[routeMarkers.length - 1].marker);
                });
            }
            if (routeMarkers.length > 1) {
                for (i = 0; i < routeMarkers.length - 1; i++) {
                    routeMarkers[i].marker.setIcon({
                        url: "8px-gray-dot.svg.png",
                        anchor: new google.maps.Point(4, 4)
                    });
                    routeMarkers[i].marker.setMap(map);
                    let rm = routeMarkers[i];
                    rm.marker.addListener("click", () => {
                        console.log("clicked");
                        infoWindowOtherPoints.close();
                        infoWindowOtherPoints.setContent(rm.popupContent);
                        infoWindowOtherPoints.open(rm.marker.getMap(), rm.marker);
                    });
                }
            }

            if (routePath) {
                routePath.setMap(null);
                routePath = null;
            }

            routePath = new google.maps.Polyline({
                path: routeMarkers.map(rm => rm.marker.getPosition()),
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 3,
            });
            routePath.setMap(map);

            runSnapToRoad(routePath.getPath());

            setTimeout(() => {
                loadRoute();
            }, 1000 * 60);


        }

        // Snap a user-created polyline to roads and draw the snapped path
        function runSnapToRoad(path) {
            var pathValues = [];
            var pathLngLat = [];
            for (var i = 0; i < path.getLength(); i++) {
                if(i>99){
                    break;
                }
                pathValues.push(path.getAt(i).toUrlValue().split(',').reverse().join());
            }

            console.log(pathValues.join(';'));
            snappedCoordinates = [];

            $.get('https://api.mapbox.com/matching/v5/mapbox/walking/' + pathValues.join(';'), {
                //interpolate: true,
                access_token: 'pk.eyJ1IjoiYWNlbWltdWhlbmRpcyIsImEiOiJjajNvZnZvd3IwMDI0MnJydHhpZjZ5bnRsIn0.mVZMKTNJSZ0rWxy1F7nXhg',
                geometries: 'geojson'
            }, function (data) {
                //processSnapToRoadResponse(data);
                //drawSnappedPolyline();

                //console.log(data);

                if (data.code == 'Ok') {
                    console.log(data.matchings[0].geometry);
                    /* for (j = 0; j < data.matchings.length; j++) {
                        let findUnmatchedPoints = true;
                        for (var i = 0; i < data.matchings[j].geometry.coordinates.length; i++) {
                            var latlng = new google.maps.LatLng(
                                data.matchings[j].geometry.coordinates[i][1],
                                data.matchings[j].geometry.coordinates[i][0]);
                            snappedCoordinates.push(latlng);
                        }
                    } */

                    let lastAddedMatchingIndex = -1;
                    data.tracepoints.forEach((tracepoint, index) => {
                        if (tracepoint) {
                            if (lastAddedMatchingIndex != tracepoint.matchings_index) {
                                lastAddedMatchingIndex = tracepoint.matchings_index;
                                for (var i = 0; i < data.matchings[lastAddedMatchingIndex].geometry.coordinates.length; i++) {
                                    var latlng = new google.maps.LatLng(
                                        data.matchings[lastAddedMatchingIndex].geometry.coordinates[i][1],
                                        data.matchings[lastAddedMatchingIndex].geometry.coordinates[i][0]);
                                    snappedCoordinates.push(latlng);
                                }
                            }
                        } else {                            
                            snappedCoordinates.push(path.getAt(index));
                        }
                    });

                    drawSnappedPolyline();
                }

            });




        }
        // Store snapped polyline returned by the snap-to-road service.
        function processSnapToRoadResponse(data) {
            snappedCoordinates = [];
            for (var i = 0; i < data.snappedPoints.length; i++) {
                var latlng = new google.maps.LatLng(
                    data.snappedPoints[i].location.latitude,
                    data.snappedPoints[i].location.longitude);
                snappedCoordinates.push(latlng);
            }
        }

        // Draws the snapped polyline (after processing snap-to-road response).
        function drawSnappedPolyline() {
            var snappedPolyline = new google.maps.Polyline({
                path: snappedCoordinates,
                strokeColor: '#3b8ced',
                strokeWeight: 5,
                strokeOpacity: 0.9,
            });

            snappedPolyline.setMap(map);
            //polylines.push(snappedPolyline);
        }
    </script>


</body>

</html>