<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <style>
        @font-face {
            font-family: 'Poppins';
            src:
                url('Poppins/Poppins-ExtraLightItalic.ttf') format('truetype')
        }

        html,
        body {
            font-family: 'Poppins', Roboto, -apple-system, "Helvetica Neue", Helvetica, "Segoe UI", Arial, sans-serif;
        }

        .leaflet-container {
            background: white;
        }

        .leaflet-interactive {
            cursor: default;
        }

        .leaflet-grab {
            cursor: -webkit-default;
            cursor: -moz-default;
            cursor: default;
        }

        .leaflet-container {
            font-family: 'Poppins', "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-size: 13px;
        }

        @media (min-width: 481px) and (max-width: 767px) {

            .leaflet-container {
                font-size: 18px;
            }

        }

        @media (max-width: 480px) {

            .leaflet-container {
                font-size: 22px;
            }

        }

        .my-div-icon {
            color: #15A2F1;
            animation: floatBubble 2s forwards linear;
            -webkit-animation: floatBubble 2s forwards linear;
            animation-iteration-count: 1;
        }

        @-webkit-keyframes floatBubble {
            0% {
                top: -10px;
                opacity: 0;
            }

            25% {
                top: -18px;
                opacity: 1;
            }

            50% {
                top: -26px;
                opacity: 1;
            }

            75% {
                top: -34px;
                opacity: 1;
            }

            100% {
                top: -42px;
                opacity: 0;
            }
        }

        @keyframes floatBubble {
            0% {
                top: -10px;
                opacity: 0;
            }

            25% {
                top: -18px;
                opacity: 1;
            }

            50% {
                top: -26px;
                opacity: 1;
            }

            75% {
                top: -34px;
                opacity: 1;
            }

            100% {
                top: -42px;
                opacity: 0;
            }
        }

        .my-div-icon-pulse {
            display: block;
            width: 0px;
            height: 0px;
            border-radius: 50%;
            background: #15A2F1;
            box-shadow: 0 0 0 rgba(21, 162, 241, 0.4);
            animation: pulse 2s forwards linear;
            -webkit-animation: pulse 2s forwards linear;
            animation-iteration-count: 1;
        }


        @-webkit-keyframes pulse {
            0% {
                -webkit-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                width: 0px;
                height: 0px;
                top: 10px;
            }

            70% {
                -webkit-box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                width: 7px;
                height: 7px;
                top: 5px;
            }

            100% {
                -webkit-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                width: 0px;
                height: 0px;
                top: 10px;
            }
        }

        @keyframes pulse {
            0% {
                -moz-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                width: 0px;
                height: 0px;
                top: 10px;
            }

            70% {
                -moz-box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                width: 7px;
                height: 7px;
                top: 5px;
            }

            100% {
                -moz-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                width: 0px;
                height: 0px;
                top: 10px;
            }
        }
        }
    </style>
</head>

<body>

    <div id="map" style="position:absolute; width: 832px; height: 401px;">

    </div>
    <script>
        const copyToClipboard = str => {
            const el = document.createElement('textarea');
            el.value = str;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        };

        var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        var inactiveDays = ['Sunday']; // ['Saturday', 'Sunday']
        var d = new Date();
        var currentDayName = days[d.getDay()];
        var currentTimeNumber = new Date().getTime();
        const speed_ms = 1000;


        var trades = [];
        var markerIndexWillPlay = 0;

        var map = L.map('map', {
            crs: L.CRS.Simple,
            zoomControl: false,
            attributionControl: false,
            zoom: 0,
            maxZoom: 0
        });
        var bounds = [[0, 0], [401, 832]];
        var image = L.imageOverlay('world.png', bounds).addTo(map);
        map.fitBounds(bounds);

        map.on('click', function (evt) {
            console.log(evt.latlng.lat + '\t' + evt.latlng.lng)

            copyToClipboard(evt.latlng.lat + '\t' + evt.latlng.lng);

        })

        var markers = [];
        var markersPulse = [];
        let myIconPulse = L.divIcon({
            className: 'my-div-icon-pulse'
        });


        if (!inactiveDays.includes(currentDayName)) {
            fetch('live-trades.json?v6')
                .then(response => response.json())
                .then(data => {
                    trades = data;
                    VisualiseTrades();
                });
        }

        function VisualiseTrades() {
            console.log('rows:', trades.filter(t => t["X"] != '').length);
            trades.filter(t => t["X"] != '').forEach(trade => {

                let myIcon = L.divIcon({
                    className: 'my-div-icon',
                    html: trade.Position,
                    iconSize: [300, 12],
                    iconAnchor: [50, 6]
                });
                let m = L.marker([trade.X, trade.Y], { icon: myIcon });
                markers.push(m);

                let mp = L.marker([trade.X, trade.Y], { icon: myIconPulse });
                markersPulse.push(mp);

            });

            currentTimeNumber = new Date().getTime();
            markerIndexWillPlay = (currentTimeNumber / speed_ms) % trades.filter(t => t["X"] != '').length;
            markerIndexWillPlay = Math.round(markerIndexWillPlay);
            console.log(markerIndexWillPlay);
            animateMarkers();

        }

        function animateMarkers() {
            if (markers.length == 0) {
                return;
            }

            setTimeout(() => {
                animateMarkers();
            }, speed_ms);
            
            if (markers.length == markerIndexWillPlay) {
                markerIndexWillPlay = 0;
            }

            if (!document.hidden) {

                markers[markerIndexWillPlay].remove();
                markers[markerIndexWillPlay].addTo(map);
                markersPulse[markerIndexWillPlay].remove();
                markersPulse[markerIndexWillPlay].addTo(map);
            }

            markerIndexWillPlay++;
        }


    </script>
</body>

</html>