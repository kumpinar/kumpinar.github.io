<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <style>
        @font-face {
            font-family: 'Poppins';
            src:
                url('Poppins/Poppins-Regular.ttf') format('truetype')
        }



        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
            width: 100vw;
            font-family: 'Poppins', Roboto, -apple-system, "Helvetica Neue", Helvetica, "Segoe UI", Arial, sans-serif;
        }

        .leaflet-container {
            background: white;
        }

        .leaflet-interactive {
            cursor: default;
        }

        .leaflet-grab {
            cursor: -webkit-default;
            cursor: -moz-default;
            cursor: default;
        }

        .leaflet-container {
            font-family: 'Poppins', "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-size: 13px;
        }

        @media (max-width: 767px) {

            .leaflet-container {
                font-size: 15px;
            }

        }

        .my-div-icon {
            color: #15A2F1;
            animation: floatBubble 2s forwards linear;
            -webkit-animation: floatBubble 2s forwards linear;
            animation-iteration-count: 1;
        }

        @-webkit-keyframes floatBubble {
            0% {
                top: -10px;
                opacity: 0;
            }

            25% {
                top: -18px;
                opacity: 1;
            }

            50% {
                top: -26px;
                opacity: 1;
            }

            75% {
                top: -34px;
                opacity: 1;
            }

            100% {
                top: -42px;
                opacity: 0;
            }
        }

        @keyframes floatBubble {
            0% {
                top: -10px;
                opacity: 0;
            }

            25% {
                top: -18px;
                opacity: 1;
            }

            50% {
                top: -26px;
                opacity: 1;
            }

            75% {
                top: -34px;
                opacity: 1;
            }

            100% {
                top: -42px;
                opacity: 0;
            }
        }



        .trade-icon {
            background-image: url(trade-favicon.png);
            opacity: 0;
            display: block;
            width: 32px;
            height: 32px;
            animation: hiding 2s forwards linear;
            -webkit-animation: hiding 2s forwards linear;
            animation-iteration-count: 1;
        }


        @-webkit-keyframes hiding {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes hiding {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }


        .my-div-icon-pulse {
            display: block;
            width: 0px;
            height: 0px;
            border-radius: 50%;
            background: #15A2F1;
            box-shadow: 0 0 0 rgba(21, 162, 241, 0.4);
            animation: pulse 2s forwards linear;
            -webkit-animation: pulse 2s forwards linear;
            animation-iteration-count: 1;
        }


        @-webkit-keyframes pulse {
            0% {
                -webkit-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                width: 0px;
                height: 0px;
                top: 10px;
            }

            70% {
                -webkit-box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                width: 7px;
                height: 7px;
                top: 5px;
            }

            100% {
                -webkit-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                width: 0px;
                height: 0px;
                top: 10px;
            }
        }

        @keyframes pulse {
            0% {
                -moz-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                box-shadow: 0 0 0 0 rgba(21, 162, 241, 0.4);
                width: 0px;
                height: 0px;
                top: 10px;
            }

            70% {
                -moz-box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                box-shadow: 0 0 0 15px rgba(21, 162, 241, 0);
                width: 7px;
                height: 7px;
                top: 5px;
            }

            100% {
                -moz-box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                box-shadow: 0 0 0 0 rgba(21, 162, 241, 0);
                width: 0px;
                height: 0px;
                top: 10px;
            }
        }
    </style>
</head>

<body>

    <div id="map">

    </div>
    <script>
        const copyToClipboard = str => {
            const el = document.createElement('textarea');
            el.value = str;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        };

        var imageWidth = 832, imageHeight = 401, mapDivWidth = 0;
        var scale = 1;
        var animateTimeout;
        var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        var inactiveDays = ['Sunday']; // ['Saturday', 'Sunday']
        var d = new Date();
        var currentDayName = days[d.getDay()];
        var currentTimeNumber = new Date().getTime();
        const speed_ms = 1000;
        const multiplePointsIndex = [4, 5, 9];


        var trades = [];
        var markerIndexWillPlay = 0;

        var map = L.map('map', {
            crs: L.CRS.Simple,
            zoomControl: false,
            attributionControl: false,
            doubleClickZoom: false,
            dragging: false,
            scrollWheelZoom: false
        });
        var bounds = [[0, 0], [imageHeight, imageWidth]];
        var image = L.imageOverlay('world.png', bounds).addTo(map);
        map.fitBounds(bounds);

        map.on('click', function (evt) {
            console.log(evt.latlng.lat + '\t' + evt.latlng.lng)

            copyToClipboard(evt.latlng.lat + '\t' + evt.latlng.lng);
        });

        function calculateScale() {

            let mapDiv = document.querySelector('#map');
            let width = mapDiv.offsetWidth;

            if (width != mapDivWidth && trades.length>0) {
                mapDivWidth = width;
                if (width < imageWidth) {
                    scale = width / imageWidth;
                }
                else {
                    scale = 1;
                }
                bounds = [[0, 0], [imageHeight * scale, imageWidth * scale]];
                image.setBounds(bounds);
                map.fitBounds(bounds);
                console.log(width);
                VisualiseTrades()
            }

        }

        setInterval(() => {
            calculateScale();
        }, 100);

        var markers = [];
        var markersPulse = [];
        var tradeFavicon = L.divIcon({
            className: 'trade-icon',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
        let myIconPulse = L.divIcon({
            className: 'my-div-icon-pulse'
        });

        if (!inactiveDays.includes(currentDayName)) {
            fetch('live-trades.json?v7')
                .then(response => response.json())
                .then(data => {
                    trades = data;
                    VisualiseTrades();
                });
        }

        function VisualiseTrades() {
            markers = [];
            markersPulse = [];
            console.log('rows:', trades.filter(t => t["X"] != '').length);
            trades.filter(t => t["X"] != '').forEach(trade => {
                let markerLabel = trade.Position;
                markerLabel = markerLabel.replace('▲', '<span style="color:black;">▲</span>');
                markerLabel = markerLabel.replace('▼', '<span style="color:black;">▼</span>');
                let myIcon = L.divIcon({
                    className: 'my-div-icon',
                    html: markerLabel,
                    iconSize: [300, 12],
                    iconAnchor: [80, 6]
                });
                let m = L.marker([trade.X * scale, trade.Y * scale], { icon: myIcon });
                markers.push(m);

                let mp = L.marker([trade.X * scale, trade.Y * scale], { icon: myIconPulse });
                markersPulse.push(mp);

            });

            currentTimeNumber = new Date().getTime();
            markerIndexWillPlay = Math.floor(currentTimeNumber / speed_ms) % trades.filter(t => t["X"] != '').length;

            if (animateTimeout) {
                clearTimeout(animateTimeout);
            }

            animateMarkers();

        }

        function animateMarkers() {
            if (markers.length == 0) {
                return;
            }

            animateTimeout = setTimeout(() => {
                animateMarkers();
            }, speed_ms);

            if (markers.length == markerIndexWillPlay) {
                markerIndexWillPlay = 0;
            }

            markers[markerIndexWillPlay].remove();
            markersPulse[markerIndexWillPlay].remove();
            if (!document.hidden) {
                markers[markerIndexWillPlay].addTo(map);
                markersPulse[markerIndexWillPlay].addTo(map);
            }


            markerIndexWillPlay++;

            multiplePointsIndex.forEach((mpIndex, index) => {
                if (markerIndexWillPlay % mpIndex == 0) {
                    for (let j = 0; j < index + 1; j++) {
                        let randomIndex = (markerIndexWillPlay + mpIndex * (j + 1)) % trades.filter(t => t["X"] != '').length;

                        markers[randomIndex].remove();
                        markersPulse[randomIndex].remove();

                        if (!document.hidden) {
                            markers[randomIndex].addTo(map);
                            markersPulse[randomIndex].addTo(map);
                        }
                    }
                }

            });
        }

        // Set the name of the hidden property and the change event for visibility
        var hidden, visibilityChange;
        if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
            hidden = "hidden";
            visibilityChange = "visibilitychange";
        } else if (typeof document.msHidden !== "undefined") {
            hidden = "msHidden";
            visibilityChange = "msvisibilitychange";
        } else if (typeof document.webkitHidden !== "undefined") {
            hidden = "webkitHidden";
            visibilityChange = "webkitvisibilitychange";
        }

        // If the page is hidden, pause the video;
        // if the page is shown, play the video
        function handleVisibilityChange() {
            if (document[hidden]) {
                return;
            } else {
                currentTimeNumber = new Date().getTime();
                markerIndexWillPlay = Math.floor(currentTimeNumber / speed_ms) % trades.filter(t => t["X"] != '').length;
            }
        }

        document.addEventListener(visibilityChange, handleVisibilityChange, false);


    </script>
</body>

</html>