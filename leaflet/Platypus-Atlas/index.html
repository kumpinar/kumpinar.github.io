<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache">
    <title>Platypus Atlas</title>

    <style>
        body {
            margin:0px;
            padding:0px;
        }
        #map{
            width:100vw;
            height:100vh;
        }

        
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            }
            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }
            .legend {
                line-height: 40px;
                color: #555;
            }
            .legend i {
                width: 50px;
                height: 18px;
                float: left;
                margin-right: 8px;
                opacity: 0.7;
            }

    </style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
crossorigin=""/>
<link href="assets/leaflet-sidebar.css" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<script src="assets/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
<script src="assets/leaflet-sidebar.js"></script>
    
</head>

<body>   

    <!-- optionally define the sidebar content via HTML markup -->
<div id="sidebar" class="leaflet-sidebar collapsed">

    <!-- nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <!-- top aligned tabs -->
        <ul role="tablist">
            <li><a href="#home" role="tab"><i class="fa fa-bars active"></i></a></li>
        </ul>

    </div>

    <!-- panel content -->
    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="home">
            <h1 class="leaflet-sidebar-header">
                Platypus Atlas
                <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
            </h1>
            
            <h2> Platypus Records</h2>
            <div>
                
            </div>
        </div>

        <div class="leaflet-sidebar-pane" id="messages">
            <h1 class="leaflet-sidebar-header">Messages<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
        </div>
    </div>
</div>

    <div id="map"></div>

    <script>

        var map = L.map('map',{
            renderer: L.canvas()
        });

        var platypusGruop = L.layerGroup().addTo(map);

        var markers = [
            L.marker([-45.3228175, 105.2460938]),
            L.marker([-10.0882278, 148.2249543])
        ];

        var group = L.featureGroup(markers).addTo(map);

        setTimeout(function () {
            map.fitBounds(group.getBounds());
            group.remove();
        }, 1000);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

         // create the sidebar instance and add it to the map
        var sidebar = L.control.sidebar({ container: 'sidebar' })
            .addTo(map)
            .open('home');


        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#6c0102",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        function onEachFeature(feature, layer) {    
            const year= feature.properties['Event Date - parsed'].split(".").length==3 ? feature.properties['Event Date - parsed'].split(".")[2] : '';
            const uncertaintyInMeters= feature.properties['Coordinate Uncertainty in Metres']==null ? '' : feature.properties['Coordinate Uncertainty in Metres'];
            layer.bindPopup('<b>Year:</b>' + year
                + '<br/><b>Spatial uncertainty in metres:</b>' + uncertaintyInMeters
            );
            platypusGruop.addLayer(layer);
        }

        function LoadData(minYear, maxYear){
            platypusGruop.clearLayers();
            $.getJSON("data/records-2020-10-29-simplified.geojson?v=3", function(data) {
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {   
                        const eventDate=feature.properties['Event Date - parsed'];                        
                        if (eventDate.split(".").length==3 && !isNaN(parseInt(eventDate.split(".")[2]))) {
                            const year= eventDate.split(".")[2];
                            if(year>=2011){
                                geojsonMarkerOptions.fillColor='#00DD00';
                            }
                            else if(year>=2001){
                                geojsonMarkerOptions.fillColor='#2EB42E';
                            }
                            else if(year>=1991){
                                geojsonMarkerOptions.fillColor='#A47B00';
                            }
                            else{
                                geojsonMarkerOptions.fillColor='#981921';
                            }
                        }
                        else{
                            geojsonMarkerOptions.fillColor='#6c0102';
                        }            
                        return L.circleMarker(latlng, geojsonMarkerOptions);                    
                    },
                    onEachFeature: onEachFeature,
                    filter: function(feature, layer) {
                        const year= feature.properties['Event Date - parsed'].split(".").length==3 ? feature.properties['Event Date - parsed'].split(".")[2] : 1801;
                        return year>=minYear && year<=maxYear;
                    }
                });
            });
        }

        LoadData(1800, 3000);

        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                colors = ['#00DD00', '#2EB42E','#A47B00','#981921','#6c0102'],
                labels = ['2011+', '2001-2010','1991-2000','&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1990','No Year Information'],
                minYears = [2011, 2001,1991,1802,1800],
                maxYears = [3000, 2010,2000,1990,1801];

            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < colors.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + colors[i] + '; cursor: pointer;" onclick="LoadData('+minYears[i]+', '+maxYears[i]+')"></i> ' +
                     labels[i] + '<br>';
            }

            div.innerHTML +='<i style="background:#e2dada; cursor: pointer;" onclick="LoadData(1800, 3000)"></i> All <br>';

            return div;
        };

        legend.addTo(map);

    </script>

</body>

</html>