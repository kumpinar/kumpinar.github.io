<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Mapbox GL</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>

  <script src="terraformer-1.0.12.min.js"></script>
  <script src="terraformer-wkt-parser-1.2.1.min.js"></script>
  <script src="turf.min.js"></script>

  <style>
    html,
    body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
    }



    #wrapper {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #left {
      flex: 1;
      padding: 1rem;
    }

    #map {
      flex: 3;
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      top: 0;
      bottom: 0;
    }

    #parcel-info {
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>

  <div id="wrapper">
    <div id="left">
      <h5> Click a parcel for information</h5>
      <div id="parcel-info">

      </div>
    </div>
    <div id="map"></div>
  </div>


</body>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYXNzZW1hMSIsImEiOiJja3ppNHJlYXAyMnc3MnNvNjgzenRvZ2NkIn0.rI0KWtTa31O7jiENm1vAmQ';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [50.066658225566016, 26.40411722910345],
    zoom: 8
  });



  map.on('load', function () {


    map.addLayer({
      "id": "district_test_id",
      "type": "fill",
      "source": {
        "type": "vector",
        "scheme": "tms",
        "tiles": ["http://3.23.244.144:8080/geoserver/gwc/service/tms/1.0.0/SA_Regions:East_Districts_parcel_11@EPSG%3A900913@pbf/{z}/{x}/{y}.pbf"],


      },
      "minzoom": 0,
      "maxzoom": 12,
      "source-layer": "East_Districts_parcel_11",
      "paint": {
        "fill-opacity": 0.6,
        "fill-color": "rgb(53, 175, 109)",
        'fill-outline-color': 'white'
      }
    });

    map.addLayer({
      "id": "zip_test_id",
      "type": "fill",
      "source": {
        "type": "vector",
        "scheme": "tms",
        "tiles": ["http://3.23.244.144:8080/geoserver/gwc/service/tms/1.0.0/SA_Regions:parcels_11_Polygonal_Buffered_Single_parts_F@EPSG%3A900913@pbf/{z}/{x}/{y}.pbf"],

      },
      "minzoom": 12,
      "maxzoom": 15,
      "source-layer": "parcels_11_Polygonal_Buffered_Single_parts_F",
      "paint": {
        "fill-opacity": 0.6,
        "fill-color": "rgb(53, 175, 109)",
        'fill-outline-color': 'white'
      }
    });

    map.addSource('parcel-source', {
      "type": "vector",
      "scheme": "tms",
      "tiles": ["http://3.23.244.144:8080/geoserver/gwc/service/tms/1.0.0/SA_Regions_PGIS%3Aparcels_11_with_east_districts_parcel_11@EPSG%3A900913@pbf/{z}/{x}/{y}.pbf"]
    });


    var parcelTypeColor = {
      "سكني": "#ede0d4",
      "تجاري": "#e6ccb2",
      "سكنى": "#ddb892",
      "تجارى": "#b08968",
      "خدمات عامة": "#bc6c25",
      "ورشة": "#dda15e",
      "المرافق العامة والنقل والاتصالات": "#ffbe0b"
    };

    var defaultParcelColor = "#7f5539";

    map.addLayer({
      "id": "parcel",
      'type': 'fill',
      "paint": {
        "fill-opacity": 0.6,
        "fill-color": [
          'match',
          ['get', 'mainlandusedescription'],
          "سكني", "#ede0d4",
          "تجاري", "#e6ccb2",
          "سكنى", "#ddb892",
          "تجارى", "#b08968",
          "خدمات عامة", "#bc6c25",
          "ورشة", "#dda15e",
          "المرافق العامة والنقل والاتصالات", "#ffbe0b",
          /* other */ "#7f5539"
        ],
        'fill-outline-color': 'white'
      },
      "source": 'parcel-source',
      "source-layer": "parcels_11_with_east_districts_parcel_11",
      "minzoom": 15,

    });

    map.addLayer(
      {
        'id': 'parcel-highlighted',
        'type': 'fill',
        'source': 'parcel-source',
        'source-layer': 'parcels_11_with_east_districts_parcel_11',
        'paint': {
          'fill-outline-color': '#484896',
          'fill-color': '#6e599f',
          'fill-opacity': 0.75
        },
        'filter': ['in', 'parcelcode', '']
      }
    );

    map.addLayer(
      {
        'id': 'parcel-selected-fill',
        'type': 'fill',
        'source': 'parcel-source',
        'source-layer': 'parcels_11_with_east_districts_parcel_11',
        'paint': {
          'fill-color': '#fff',
          'fill-opacity': 0.9
        },
        'filter': ['in', 'parcelcode', '']
      }
    );

    map.addLayer(
      {
        'id': 'parcel-selected',
        'type': 'line',
        'source': 'parcel-source',
        'source-layer': 'parcels_11_with_east_districts_parcel_11',
        'paint': {
          'line-color': 'red',
          'line-width': 3,
          'line-opacity': 0.5
        },
        'layout': {
          'line-join': 'round',
          'line-cap': 'round'
        },
        'filter': ['in', 'parcelcode', '']
      }
    );



    map.addSource('centroids-source', {
      "type": "geojson",
      "data": null
    });

    map.addLayer({
      'id': 'length_centroids_label',
      'type': 'symbol',
      'source': 'centroids-source',
      "minzoom": 15,
      'layout': {
        "text-field": "{length}",
        "text-size": 9,
        'visibility': 'visible',
        'text-offset': [0, 1],
      }
    });

    map.addLayer({
      'id': 'length_centroids_point',
      'type': 'circle',
      'source': 'centroids-source',
      "minzoom": 15,
      'paint': {
        // Make circles larger as the user zooms from z12 to z22.
        'circle-radius': 3
      }
    });
  });

  map.on('click', 'parcel', function (e) {
    map.setFilter('parcel-selected', ['in', 'parcelcode', e.features[0].properties.parcelcode]);
    map.setFilter('parcel-selected-fill', ['in', 'parcelcode', e.features[0].properties.parcelcode]);
    fetch(`http://3.23.244.144:8080/geoserver/SA_Regions_PGIS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=parcels_11_with_east_districts_parcel_11&FEATUREID=${e.features[0].id}&outputFormat=application%2Fjson`)
      .then(response => response.json())
      .then(parcelPolygon => {
        let polygonWkt = Terraformer.WKT.convert(parcelPolygon.features[0].geometry);
        let cql = `DWITHIN(geom, ${polygonWkt}, 0.000001, meters)`;
        fetch(`http://3.23.244.144:8080/geoserver/SA_Regions/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=parcels_11_Exploded_Saved_Dims_Centroids&outputFormat=application%2Fjson&CQL_FILTER=${cql}`)
          .then(response => response.json())
          .then(centroids => {
            map.getSource('centroids-source').setData(centroids);
          }
          );
      }
      );

    const centroinds = map.querySourceFeatures('centroids-source', {
      sourceLayer: 'parcels_11_Exploded_Saved_Dims_Centroids'
    });
    showParcelProperties(e.features[0].properties);
  });
  map.on('mouseleave', 'parcel', function (e) {
    map.setFilter('parcel-highlighted', ['in', 'parcelcode', '']);
  });

  map.on('mousemove', (e) => {
    const features = map.queryRenderedFeatures(e.point, {
      layers: ['parcel']
    });
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = features.length ? 'pointer' : '';
    if (features && features.length > 0) {
      map.setFilter('parcel-highlighted', ['in', 'parcelcode', features[0].properties.parcelcode]);
    }
  });

  map.on('click', (e) => {
    const features = map.queryRenderedFeatures(
      e.point,
      { layers: ['parcel'] }
    );
    if (features.length == 0) {
      map.setFilter('parcel-selected', ['in', 'parcelcode', '']);
      map.setFilter('parcel-selected-fill', ['in', 'parcelcode', '']);
      map.getSource('centroids-source').setData({
        "type": "FeatureCollection",
        "features": []
      });
      document.querySelector("#parcel-info").innerHTML = '';
    }
  });

  map.addControl(new mapboxgl.NavigationControl());
  map.addControl(new mapboxgl.ScaleControl());
  map.addControl(new mapboxgl.FullscreenControl());

  function showParcelProperties(properties) {
    let propHtml = '';
    Object.keys(properties).forEach(key => {

      propHtml += `<div><strong>${key}</strong>: ${properties[key]}</div>`

    });

    document.querySelector("#parcel-info").innerHTML = propHtml;
  }



</script>

</html>